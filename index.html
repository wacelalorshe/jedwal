<!DOCTYPE html>
<html lang='ar' dir='rtl'>
<head>
    <meta charset='UTF-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>وسيل لايف برو - بث المباريات</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <h2 id="page-title">جاري التحميل...</h2>
    
    <div id="matches-container">
        <div class="loading">جاري تحميل المباريات...</div>
    </div>
    
    <a href="admin.html" class="admin-link">لوحة التحكم</a>

    <!-- إعدادات Firebase -->
    <script src="firebase-config.js"></script>
    
    <script>
        // الانتظار حتى تحميل Firebase
        document.addEventListener('DOMContentLoaded', function() {
            // تحديث التاريخ في العنوان
            const today = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('page-title').textContent = `مباريات اليوم | ${today.toLocaleDateString('ar-AR', options)}`;
            
            // تحميل المباريات بعد التأكد من تهيئة Firebase
            const checkFirebase = setInterval(() => {
                if (window.firebaseDb && window.firebaseModules) {
                    clearInterval(checkFirebase);
                    loadMatches();
                }
            }, 100);
            
            function loadMatches() {
                const matchesContainer = document.getElementById('matches-container');
                const { ref, onValue } = window.firebaseModules;
                
                // الاستماع للتحديثات في قاعدة البيانات
                const matchesRef = ref(window.firebaseDb, 'matches');
                onValue(matchesRef, (snapshot) => {
                    matchesContainer.innerHTML = '';
                    
                    if (!snapshot.exists()) {
                        matchesContainer.innerHTML = '<div class="loading">لا توجد مباريات اليوم</div>';
                        return;
                    }
                    
                    let currentLeague = '';
                    let hasMatches = false;
                    
                    snapshot.forEach((childSnapshot) => {
                        hasMatches = true;
                        const match = childSnapshot.val();
                        
                        // إذا تغير الدوري، نضيف عنوان الدوري الجديد
                        if (match.league !== currentLeague) {
                            currentLeague = match.league;
                            
                            const leagueContainer = document.createElement('div');
                            leagueContainer.className = 'flex-container';
                            leagueContainer.innerHTML = `
                                <b>${match.league}</b>
                                <div class="img">
                                    <img src="${match.leagueLogo || 'https://i.postimg.cc/Bb0WFJfJ/Picsart-25-01-18-03-49-12-620.png'}" style="width: 80px; height: 45px;" alt="${match.league}">
                                </div>
                            `;
                            
                            matchesContainer.appendChild(leagueContainer);
                        }
                        
                        // إنشاء رابط المشاهدة المشفر (base64)
                        const encodedLinks = btoa(JSON.stringify(match.links || []));
                        const watchLink = "xmtv://" + encodedLinks;
                        
                        // إنشاء عنصر المباراة
                        const matchElement = document.createElement('a');
                        matchElement.href = watchLink;
                        matchElement.className = 'match-box';
                        matchElement.target = "_blank";
                        matchElement.innerHTML = `
                            <div class='match-info'>
                                <div>
                                    <img src='${match.team1Logo || 'https://via.placeholder.com/40?text=T1'}' alt='${match.team1}'>
                                    <p>${match.team1}</p>
                                </div>
                                <div><span class='match-time'>${match.time}</span></div>
                                <div>
                                    <img src='${match.team2Logo || 'https://via.placeholder.com/40?text=T2'}' alt='${match.team2}'>
                                    <p>${match.team2}</p>
                                </div>
                            </div>
                            <div class='match-details'>
                                <div>${match.channel}</div>
                                <div>${match.commentator}</div>
                            </div>
                        `;
                        
                        matchesContainer.appendChild(matchElement);
                    });
                    
                    if (!hasMatches) {
                        matchesContainer.innerHTML = '<div class="loading">لا توجد مباريات متاحة حالياً</div>';
                    }
                }, (error) => {
                    console.error("خطأ في تحميل المباريات:", error);
                    matchesContainer.innerHTML = '<div class="error">حدث خطأ في تحميل المباريات. يرجى المحاولة لاحقاً.</div>';
                });
            }
        });
    </script>
</body>
</html>
