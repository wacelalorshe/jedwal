<!DOCTYPE html>
<html lang='ar' dir='rtl'>
<head>
    <meta charset='UTF-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التحكم - وسيل لايف برو</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <h2>لوحة تحكم - وسيل لايف برو</h2>

    <div class="container">
        <!-- قسم تسجيل الدخول -->
        <div id="login-section" class="form-container">
            <h3>تسجيل الدخول للإدارة</h3>
            <form id="login-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="email">البريد الإلكتروني</label>
                        <input type="email" id="email" required>
                    </div>
                    <div class="form-group">
                        <label for="password">كلمة المرور</label>
                        <input type="password" id="password" required>
                    </div>
                </div>
                <div class="form-row">
                    <button type="submit" class="btn btn-primary">تسجيل الدخول</button>
                </div>
                <div id="login-message"></div>
                <div class="form-row">
                    <small>للتجربة: يمكن استخدام أي بريد إلكتروني وكلمة مرور في وضع التطوير</small>
                </div>
            </form>
        </div>

        <!-- قسم لوحة التحكم (مخفي حتى تسجيل الدخول) -->
        <div id="dashboard-section" class="hidden">
            <div class="form-container">
                <h3 id="form-title">إضافة مباراة جديدة</h3>
                <form id="match-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="league">الدوري *</label>
                            <input type="text" id="league" required placeholder="مثال: الدوري الانجليزي الممتاز">
                        </div>
                        <div class="form-group">
                            <label for="league-logo">رابط شعار الدوري</label>
                            <input type="text" id="league-logo" placeholder="https://example.com/logo.png">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="team1">الفريق الأول *</label>
                            <input type="text" id="team1" required placeholder="مثال: نوتينغهام">
                        </div>
                        <div class="form-group">
                            <label for="team1-logo">رابط شعار الفريق الأول</label>
                            <input type="text" id="team1-logo" placeholder="https://example.com/team1.png">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="team2">الفريق الثاني *</label>
                            <input type="text" id="team2" required placeholder="مثال: برينتفورد">
                        </div>
                        <div class="form-group">
                            <label for="team2-logo">رابط شعار الفريق الثاني</label>
                            <input type="text" id="team2-logo" placeholder="https://example.com/team2.png">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="match-time">وقت المباراة *</label>
                            <input type="text" id="match-time" required placeholder="مثال: 04:00م">
                        </div>
                        <div class="form-group">
                            <label for="channel">القناة الناقلة *</label>
                            <input type="text" id="channel" required placeholder="مثال: bein sport 2">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="commentator">اسم المعلق *</label>
                            <input type="text" id="commentator" required placeholder="مثال: أحمد البلوشي">
                        </div>
                        <div class="form-group">
                            <label for="match-date">التاريخ *</label>
                            <input type="text" id="match-date" required placeholder="مثال: الأحد 17 أغسطس 2025">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="links">روابط المشاهدة * (كل رابط في سطر جديد)</label>
                            <textarea id="links" required placeholder="https://example.com/stream1
https://example.com/stream2
https://example.com/stream3"></textarea>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <button type="submit" class="btn btn-primary" id="submit-btn">إضافة المباراة</button>
                        <button type="button" class="btn btn-danger hidden" id="cancel-btn">إلغاء التعديل</button>
                        <button type="button" class="btn btn-secondary" id="logout-btn">تسجيل الخروج</button>
                        <a href="index.html" class="btn btn-success">عرض الموقع</a>
                    </div>
                    <div id="form-message"></div>
                </form>
            </div>

            <div class="matches-container">
                <h3>المباريات المضافة</h3>
                <div id="matches-list">
                    <div class="loading">جاري تحميل المباريات...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- تحميل Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    
    <!-- إعدادات Firebase -->
    <script src="firebase-config.js"></script>
    
    <script>
        // الانتظار حتى تحميل DOM وFirebase
        document.addEventListener('DOMContentLoaded', function() {
            // عناصر DOM
            const loginSection = document.getElementById('login-section');
            const dashboardSection = document.getElementById('dashboard-section');
            const loginForm = document.getElementById('login-form');
            const logoutBtn = document.getElementById('logout-btn');
            const loginMessage = document.getElementById('login-message');
            
            const matchForm = document.getElementById('match-form');
            const formTitle = document.getElementById('form-title');
            const submitBtn = document.getElementById('submit-btn');
            const cancelBtn = document.getElementById('cancel-btn');
            const formMessage = document.getElementById('form-message');
            const matchesList = document.getElementById('matches-list');
            
            let currentEditId = null;
            
            // التحقق من حالة المصادقة
            const checkAuth = setInterval(() => {
                if (window.firebaseAuth) {
                    clearInterval(checkAuth);
                    
                    window.firebaseAuth.onAuthStateChanged(function(user) {
                        if (user) {
                            // المستخدم مسجل الدخول
                            loginSection.classList.add('hidden');
                            dashboardSection.classList.remove('hidden');
                            loadMatches();
                            showMessage(loginMessage, "تم تسجيل الدخول بنجاح!", "success");
                        } else {
                            // المستخدم غير مسجل الدخول
                            loginSection.classList.remove('hidden');
                            dashboardSection.classList.add('hidden');
                        }
                    });
                }
            }, 100);
            
            // تسجيل الدخول
            loginForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                const loginBtn = loginForm.querySelector('button[type="submit"]');
                
                // تعطيل الزر أثناء المعالجة
                loginBtn.disabled = true;
                loginBtn.textContent = "جاري تسجيل الدخول...";
                
                window.firebaseAuth.signInWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        showMessage(loginMessage, "تم تسجيل الدخول بنجاح!", "success");
                    })
                    .catch((error) => {
                        let errorMessage = "خطأ في تسجيل الدخول";
                        
                        if (error.code === 'auth/invalid-credential') {
                            errorMessage = "البريد الإلكتروني أو كلمة المرور غير صحيحة";
                        } else if (error.code === 'auth/user-not-found') {
                            errorMessage = "لم يتم العثور على مستخدم بهذا البريد الإلكتروني";
                        } else if (error.code === 'auth/wrong-password') {
                            errorMessage = "كلمة المرور غير صحيحة";
                        } else {
                            errorMessage = error.message;
                        }
                        
                        showMessage(loginMessage, errorMessage, "error");
                    })
                    .finally(() => {
                        // إعادة تمكين الزر
                        loginBtn.disabled = false;
                        loginBtn.textContent = "تسجيل الدخول";
                    });
            });
            
            // تسجيل الخروج
            logoutBtn.addEventListener('click', function() {
                window.firebaseAuth.signOut()
                    .then(() => {
                        showMessage(loginMessage, "تم تسجيل الخروج بنجاح", "success");
                    })
                    .catch((error) => {
                        console.error('خطأ في تسجيل الخروج:', error);
                    });
            });
            
            // إرسال نموذج المباراة
            matchForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                if (!window.firebaseAuth.currentUser) {
                    showMessage(formMessage, "يجب تسجيل الدخول أولاً", "error");
                    return;
                }
                
                // جمع البيانات من النموذج
                const matchData = {
                    league: document.getElementById('league').value,
                    leagueLogo: document.getElementById('league-logo').value,
                    team1: document.getElementById('team1').value,
                    team1Logo: document.getElementById('team1-logo').value,
                    team2: document.getElementById('team2').value,
                    team2Logo: document.getElementById('team2-logo').value,
                    time: document.getElementById('match-time').value,
                    channel: document.getElementById('channel').value,
                    commentator: document.getElementById('commentator').value,
                    date: document.getElementById('match-date').value,
                    links: document.getElementById('links').value.split('\n').filter(link => link.trim() !== ''),
                    createdAt: firebase.database.ServerValue.TIMESTAMP
                };
                
                // تعطيل الزر أثناء المعالجة
                submitBtn.disabled = true;
                submitBtn.textContent = "جاري الحفظ...";
                
                if (currentEditId) {
                    // تحديث مباراة موجودة
                    window.firebaseDb.ref('matches/' + currentEditId).update(matchData)
                        .then(() => {
                            showMessage(formMessage, "تم تحديث المباراة بنجاح!", "success");
                            resetForm();
                        })
                        .catch(error => {
                            showMessage(formMessage, "حدث خطأ أثناء تحديث المباراة: " + error.message, "error");
                        })
                        .finally(() => {
                            submitBtn.disabled = false;
                            submitBtn.textContent = "تحديث المباراة";
                        });
                } else {
                    // إضافة مباراة جديدة
                    window.firebaseDb.ref('matches').push(matchData)
                        .then(() => {
                            showMessage(formMessage, "تم إضافة المباراة بنجاح!", "success");
                            resetForm();
                        })
                        .catch(error => {
                            showMessage(formMessage, "حدث خطأ أثناء إضافة المباراة: " + error.message, "error");
                        })
                        .finally(() => {
                            submitBtn.disabled = false;
                            submitBtn.textContent = "إضافة المباراة";
                        });
                }
            });
            
            // إلغاء التعديل
            cancelBtn.addEventListener('click', resetForm);
            
            // تحميل المباريات للعرض في لوحة التحكم
            function loadMatches() {
                window.firebaseDb.ref('matches').on('value', function(snapshot) {
                    matchesList.innerHTML = '';
                    
                    if (!snapshot.exists()) {
                        matchesList.innerHTML = '<div class="loading">لا توجد مباريات مضافة</div>';
                        return;
                    }
                    
                    snapshot.forEach(function(childSnapshot) {
                        const matchId = childSnapshot.key;
                        const match = childSnapshot.val();
                        
                        const matchItem = document.createElement('div');
                        matchItem.className = 'match-item';
                        matchItem.innerHTML = `
                            <div class="match-header">
                                <h4>${match.league}</h4>
                                <div class="actions">
                                    <button class="btn btn-primary" onclick="editMatch('${matchId}')">تعديل</button>
                                    <button class="btn btn-danger" onclick="deleteMatch('${matchId}')">حذف</button>
                                </div>
                            </div>
                            <div class="match-teams">
                                <div class="match-team">
                                    <img src="${match.team1Logo || 'https://via.placeholder.com/50?text=T1'}" alt="${match.team1}">
                                    <span>${match.team1}</span>
                                </div>
                                <div class="match-time">${match.time}</div>
                                <div class="match-team">
                                    <img src="${match.team2Logo || 'https://via.placeholder.com/50?text=T2'}" alt="${match.team2}">
                                    <span>${match.team2}</span>
                                </div>
                            </div>
                            <div class="match-details">
                                <div>${match.channel}</div>
                                <div>${match.commentator}</div>
                            </div>
                            <div class="links-container">
                                <strong>روابط المشاهدة (${match.links ? match.links.length : 0}):</strong>
                                ${match.links ? match.links.map((link, index) => 
                                    `<div class="link-item">${index + 1}. ${link}</div>`
                                ).join('') : '<div class="link-item">لا توجد روابط</div>'}
                            </div>
                        `;
                        
                        matchesList.appendChild(matchItem);
                    });
                }, function(error) {
                    matchesList.innerHTML = '<div class="error">حدث خطأ في تحميل المباريات</div>';
                    console.error("خطأ في تحميل المباريات:", error);
                });
            }
            
            // تعريف الدوال العالمية
            window.editMatch = function(matchId) {
                window.firebaseDb.ref('matches/' + matchId).once('value')
                    .then(function(snapshot) {
                        const match = snapshot.val();
                        
                        // تعبئة النموذج ببيانات المباراة
                        document.getElementById('league').value = match.league || '';
                        document.getElementById('league-logo').value = match.leagueLogo || '';
                        document.getElementById('team1').value = match.team1 || '';
                        document.getElementById('team1-logo').value = match.team1Logo || '';
                        document.getElementById('team2').value = match.team2 || '';
                        document.getElementById('team2-logo').value = match.team2Logo || '';
                        document.getElementById('match-time').value = match.time || '';
                        document.getElementById('channel').value = match.channel || '';
                        document.getElementById('commentator').value = match.commentator || '';
                        document.getElementById('match-date').value = match.date || '';
                        document.getElementById('links').value = match.links ? match.links.join('\n') : '';
                        
                        // تغيير حالة النموذج إلى وضع التعديل
                        formTitle.textContent = 'تعديل المباراة';
                        submitBtn.textContent = 'تحديث المباراة';
                        cancelBtn.classList.remove('hidden');
                        currentEditId = matchId;
                        
                        // التمرير إلى أعلى النموذج
                        matchForm.scrollIntoView({ behavior: 'smooth' });
                    })
                    .catch(error => {
                        showMessage(formMessage, "حدث خطأ أثناء تحميل بيانات المباراة: " + error.message, "error");
                    });
            };
            
            window.deleteMatch = function(matchId) {
                if (confirm('هل أنت متأكد من حذف هذه المباراة؟')) {
                    window.firebaseDb.ref('matches/' + matchId).remove()
                        .then(() => {
                            showMessage(formMessage, "تم حذف المباراة بنجاح!", "success");
                        })
                        .catch(error => {
                            showMessage(formMessage, "حدث خطأ أثناء حذف المباراة: " + error.message, "error");
                        });
                }
            };
            
            // إعادة تعيين النموذج
            function resetForm() {
                matchForm.reset();
                formTitle.textContent = 'إضافة مباراة جديدة';
                submitBtn.textContent = 'إضافة المباراة';
                cancelBtn.classList.add('hidden');
                currentEditId = null;
                formMessage.innerHTML = '';
            }
            
            // عرض الرسائل
            function showMessage(element, message, type) {
                element.innerHTML = `<div class="${type}">${message}</div>`;
                
                // إخفاء الرسالة تلقائياً بعد 5 ثوانٍ
                setTimeout(() => {
                    element.innerHTML = '';
                }, 5000);
            }
        });
    </script>
</body>
</html>
